#!/bin/sh

## ==== FAILS

## Get an authorisation token from Azure using the authorisation code flow


curl https://login.microsoftonline.com/4395f4a7-e455-4f95-8a9f-1fbaef6384f9/oauth2/v2.0/authorize?client_id=a462354f-fd23-4fdf-94f5-5cce5a6c27c7&response_type=code&redirect_uri=https%3A%2F%2Flogin.microsoftonline.com%2Fcommon%2Foauth2%2Fnativeclient&response_mode=query&scope=Calendars.Read

## Notes

## See here for Microsoft Graph documentation:
## https://docs.microsoft.com/en-us/graph/

## See here for useful information about this specific app in the Turing AD:
## https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationMenuBlade/Overview/appId/a462354f-fd23-4fdf-94f5-5cce5a6c27c7/objectId/a8270fdf-7795-4d94-a178-1755bf8613bf/isMSAApp/

## 4395f4a7-e455-4f95-8a9f-1fbaef6384f9 is the GUID for our AD "tenant"
## A "tenant" is (I believe) Microsoft's name for an instance of AD.


## ==== SUCCEEDS!

## Authorise using the device code flow
## Note the Microsoft's documentation lies to some extent: the URL is as below, not ../devicecode as on
## https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-device-code

## Ask user to sign in

curl -v -d 'client_id=a462354f-fd23-4fdf-94f5-5cce5a6c27c7&scope=Calendars.Read.Shared%20offline_access' https://login.microsoftonline.com/4395f4a7-e455-4f95-8a9f-1fbaef6384f9/oauth2/v2.0/devicecode

## Get token (replace device_code with the appropriate value!)

curl -v -d 'client_id=a462354f-fd23-4fdf-94f5-5cce5a6c27c7&grant_type=urn:ietf:params:oauth:grant-type:device_code&device_code=DAQABAAEAAADCoMpjJXrxTq9VG9te-7FXMq_OHQH7TO4JUerzSmBVhk9sWjXVJAQcbmVUlA-h5iKykm9PJz7YDWZJ0yuwDbpcWSDp2JFEG-oJf5UZmRVlsGOP4d1AiACjoMhisGpZjDa7frw3ux8QyA1DTaQgvGIeiBcnoVGFPoYqkdfwrfPVLyAA' https://login.microsoftonline.com/4395f4a7-e455-4f95-8a9f-1fbaef6384f9/oauth2/v2.0/token


## ==== GET SOME DATA

curl -v --header "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJub25jZSI6IkFRQUJBQUFBQUFEQ29NcGpKWHJ4VHE5Vkc5dGUtN0ZYS0tKbWxwN1pOUHVfMVRIQUM2V2ZuVk1LNmZSeVpSWHhUY2d6dFBkck4zMkVkZ3J1SDVlTmp3WmFRZjgxc1VxZHVnc3dnSXI5MWNDSnBraFNON0cyWmlBQSIsImFsZyI6IlJTMjU2IiwieDV0IjoiSEJ4bDltQWU2Z3hhdkNrY29PVTJUSHNETmEwIiwia2lkIjoiSEJ4bDltQWU2Z3hhdkNrY29PVTJUSHNETmEwIn0.eyJhdWQiOiJodHRwczovL2dyYXBoLm1pY3Jvc29mdC5jb20iLCJpc3MiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC80Mzk1ZjRhNy1lNDU1LTRmOTUtOGE5Zi0xZmJhZWY2Mzg0ZjkvIiwiaWF0IjoxNTU3MzE3NzUwLCJuYmYiOjE1NTczMTc3NTAsImV4cCI6MTU1NzMyMTY1MCwiYWNjdCI6MCwiYWNyIjoiMSIsImFpbyI6IkFWUUFxLzhMQUFBQWs4Ylp4WWdBMklhUTFmODhmWTQyL3F2TXFYV3lhcjlnMzZHU3NrZVpZUTNyMENWa0dlNGgrVU0rNUVtMVZXelJZL1lPTTdtNUNwQ1VnSXB0V005ZVBmNkJSc1FnUW1IN3JQU3hwZUUrYlVrPSIsImFtciI6WyJwd2QiLCJtZmEiXSwiYXBwX2Rpc3BsYXluYW1lIjoiTWVldGluZyBSb29tIEF2YWlsYWJpbGl0eSBDaGVja2VyIiwiYXBwaWQiOiJhNDYyMzU0Zi1mZDIzLTRmZGYtOTRmNS01Y2NlNWE2YzI3YzciLCJhcHBpZGFjciI6IjAiLCJmYW1pbHlfbmFtZSI6IkdlZGRlcyIsImdpdmVuX25hbWUiOiJKYW1lcyIsImlwYWRkciI6IjE5My42MC4yMjAuMjUzIiwibmFtZSI6IkphbWVzIEdlZGRlcyIsIm9pZCI6ImE1OGY4YmNmLWM0MTUtNDJjMS1iNDFkLWE4NTU3MWYxYmIzYyIsIm9ucHJlbV9zaWQiOiJTLTEtNS0yMS0xNTIzMTI5NDQwLTMxMDgxMTY1ODctMjI2NTAzNTY1OC0xNDg4IiwicGxhdGYiOiIxNCIsInB1aWQiOiIxMDAzM0ZGRjk3MTQ5OTQyIiwic2NwIjoiQ2FsZW5kYXJzLlJlYWQuU2hhcmVkIFVzZXIuUmVhZCBwcm9maWxlIG9wZW5pZCBlbWFpbCIsInNpZ25pbl9zdGF0ZSI6WyJrbXNpIl0sInN1YiI6Inl0TWR4al9QWjJPM0FCTTVWVzlxLXZVdkwzWmdsTUdsSmNleVlYblpNY2MiLCJ0aWQiOiI0Mzk1ZjRhNy1lNDU1LTRmOTUtOGE5Zi0xZmJhZWY2Mzg0ZjkiLCJ1bmlxdWVfbmFtZSI6ImpnZWRkZXNAdHVyaW5nLmFjLnVrIiwidXBuIjoiamdlZGRlc0B0dXJpbmcuYWMudWsiLCJ1dGkiOiJoZkR4b2pVWlhrZWRITE4xRS1tTkFBIiwidmVyIjoiMS4wIiwieG1zX3N0Ijp7InN1YiI6IlRTVHhpczg4Qnp5UW9BcV9FR3puZ3hfa05IMzBVam8zT3NRSmZpbmZ1akEifSwieG1zX3RjZHQiOjE0MzgwOTczNTl9.wrjYG8k6XdxBNpuDmPN8N32mJGGtUWY6sfOdsE15O6hdTNb5ply5hlI_mXGhsVoQCAdHyctIUzOw_qhC4ob-fkuXmHHZCOEt3yUrbDw6X8X_L0_pvzatZu5wgGT6mPwdQ5FimWvL9ZMBA5_mcbEOYvUEzSpBXMYPmWPmWOzeoAgOWh4RJpCS2P9oxNtbH_RI-5Cg0xy6Xqpx77WVaDVI_9pQl8ym_7JXYBkr3AWBrKFLy3dE832rU3qFvb3OzsvAi3rp5v1cBp4ObCZKxF7nX2jqLknrg77xfoJFWLqR2DEwnO06owyH0PUixGMZWVFx2Y44j8v4L87uuMea5O23_w" https://graph.microsoft.com/v1.0/me/

curl -v --request POST \
     --url https://graph.microsoft.com/v1.0/me/calendar/getschedule \
     --header 'Prefer: outlook.timezone="Europe/London"' \
  --header 'authorization: Bearer eyJ0eXAiOiJKV1QiLCJub25jZSI6IkFRQUJBQUFBQUFEQ29NcGpKWHJ4VHE5Vkc5dGUtN0ZYakdWdWRpZEp4S2hucWhyaThScEppNm9uMTJ4T3ZSbUZHbUhWZGpkUFZDMktpYkpNQWVCOHpaNW5YbW4xSnBfUDFrSjg0NWJrVWtFNEdiVXc5X1FCNHlBQSIsImFsZyI6IlJTMjU2IiwieDV0IjoiSEJ4bDltQWU2Z3hhdkNrY29PVTJUSHNETmEwIiwia2lkIjoiSEJ4bDltQWU2Z3hhdkNrY29PVTJUSHNETmEwIn0.eyJhdWQiOiJodHRwczovL2dyYXBoLm1pY3Jvc29mdC5jb20iLCJpc3MiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC80Mzk1ZjRhNy1lNDU1LTRmOTUtOGE5Zi0xZmJhZWY2Mzg0ZjkvIiwiaWF0IjoxNTU3Njc3NDE2LCJuYmYiOjE1NTc2Nzc0MTYsImV4cCI6MTU1NzY4MTMxNiwiYWNjdCI6MCwiYWNyIjoiMSIsImFpbyI6IkFVUUF1LzhMQUFBQUdhbENWVEJxWFk3WjlaTnIzS2pDUFBoMFR5UHpvKzQ5V3NYTFg4WmdXYmpMTkNhUTF3ckV1bTJxWVhJNFg5ak9jTVl6RzJIaVhSVTFweUR2RzFBUHF3PT0iLCJhbXIiOlsicHdkIiwibWZhIl0sImFwcF9kaXNwbGF5bmFtZSI6Ik1lZXRpbmcgUm9vbSBBdmFpbGFiaWxpdHkgQ2hlY2tlciIsImFwcGlkIjoiYTQ2MjM1NGYtZmQyMy00ZmRmLTk0ZjUtNWNjZTVhNmMyN2M3IiwiYXBwaWRhY3IiOiIwIiwiZmFtaWx5X25hbWUiOiJHZWRkZXMiLCJnaXZlbl9uYW1lIjoiSmFtZXMiLCJpcGFkZHIiOiIzMS41MC4xNy43MyIsIm5hbWUiOiJKYW1lcyBHZWRkZXMiLCJvaWQiOiJhNThmOGJjZi1jNDE1LTQyYzEtYjQxZC1hODU1NzFmMWJiM2MiLCJvbnByZW1fc2lkIjoiUy0xLTUtMjEtMTUyMzEyOTQ0MC0zMTA4MTE2NTg3LTIyNjUwMzU2NTgtMTQ4OCIsInBsYXRmIjoiMTQiLCJwdWlkIjoiMTAwMzNGRkY5NzE0OTk0MiIsInNjcCI6IkNhbGVuZGFycy5SZWFkLlNoYXJlZCBVc2VyLlJlYWQgcHJvZmlsZSBvcGVuaWQgZW1haWwiLCJzaWduaW5fc3RhdGUiOlsia21zaSJdLCJzdWIiOiJ5dE1keGpfUFoyTzNBQk01Vlc5cS12VXZMM1pnbE1HbEpjZXlZWG5aTWNjIiwidGlkIjoiNDM5NWY0YTctZTQ1NS00Zjk1LThhOWYtMWZiYWVmNjM4NGY5IiwidW5pcXVlX25hbWUiOiJqZ2VkZGVzQHR1cmluZy5hYy51ayIsInVwbiI6ImpnZWRkZXNAdHVyaW5nLmFjLnVrIiwidXRpIjoiTHpiUGd5S1VjVW0zTzhGN2pXWWlBQSIsInZlciI6IjEuMCIsInhtc19zdCI6eyJzdWIiOiJUU1R4aXM4OEJ6eVFvQXFfRUd6bmd4X2tOSDMwVWpvM09zUUpmaW5mdWpBIn0sInhtc190Y2R0IjoxNDM4MDk3MzU5fQ.rjik9PJb8N9eCI_3MDd7voNeKXQevkszux8VShvwATWhdn54BJcSW9xUMf0DVV_QDKmMGbwQB1MMFJFgHrYC5axI1i0L_VLNyDwxzTOM9CS4HYQ_28suzDFJkcJd24UBZj1K-DoYMMOOcXg7kPWcxBo2UeIS-_RcqZ_GFviRvLbN5PBkFJLhl_t7p3DuKnc5664X5d2y_PrljpjBZsYF3FVQYxsYRkqq6FLCEZS-kZPSCov0-sESEXSPTVvqnk1DH773_WHmtjzr6DiC3xGaadNHS4CnwfcDLGrcHlGH_raTmQFAdiCvjvdWLNU518jAXRxKXHMtqgREd8Xy83NzWQ' \
  --header 'content-type: application/json' \
  --data '{
  "Schedules": [
    "davidblackwell@turing.ac.uk",
    "jackgood@turing.ac.uk"
  ],
  "StartTime": {
    "dateTime": "2019-05-08T07:00:00",
    "timeZone": "GMT"
  },
  "EndTime": {
    "dateTime": "2019-05-08T18:00:00",
    "timeZone": "GMT"
  },
  "availabilityViewInterval": "30"
(}'
